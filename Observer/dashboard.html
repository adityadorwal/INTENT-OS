<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Tracker Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeInDown 0.6s ease;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        header p {
            font-size: 1.2em;
            opacity: 0.95;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
            animation: fadeInUp 0.6s ease 0.2s backwards;
        }

        .tab {
            padding: 14px 28px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .tab:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .tab:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .dashboard {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: scaleIn 0.6s ease 0.4s backwards;
            min-height: 400px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            padding: 25px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
            pointer-events: none;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .stat-card .subtext {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 8px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
        }

        .chart-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .chart-card h3 {
            color: #555;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .app-list {
            list-style: none;
        }

        .app-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            background: #f8f9fa;
            margin-bottom: 12px;
            border-radius: 10px;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .app-item:hover {
            background: #e9ecef;
            transform: translateX(8px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .app-item:nth-child(1):hover {
            border-left-color: #667eea;
        }

        .app-item:nth-child(2):hover {
            border-left-color: #10b981;
        }

        .app-item:nth-child(3):hover {
            border-left-color: #3b82f6;
        }

        .app-item:nth-child(4):hover {
            border-left-color: #f59e0b;
        }

        .app-item:nth-child(5):hover {
            border-left-color: #ef4444;
        }

        .app-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .app-rank {
            font-size: 18px;
            font-weight: bold;
            color: #999;
            min-width: 30px;
        }

        .app-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .app-category {
            padding: 5px 14px;
            background: #667eea;
            color: white;
            border-radius: 14px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .app-category.productive {
            background: #10b981;
        }

        .app-category.communication {
            background: #3b82f6;
        }

        .app-category.browsing {
            background: #f59e0b;
        }

        .app-category.entertainment {
            background: #ef4444;
        }

        .app-time {
            font-weight: bold;
            color: #667eea;
            font-size: 20px;
        }

        .app-percentage {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.8s ease;
            border-radius: 3px;
        }

        .app-item:nth-child(1) .progress-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .app-item:nth-child(2) .progress-fill {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        .app-item:nth-child(3) .progress-fill {
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
        }

        .app-item:nth-child(4) .progress-fill {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
        }

        .app-item:nth-child(5) .progress-fill {
            background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e9ecef;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .error {
            background: linear-gradient(135deg, #fee 0%, #fdd 100%);
            border: 2px solid #fcc;
            padding: 30px;
            border-radius: 12px;
            color: #c33;
        }

        .error h3 {
            margin-bottom: 15px;
            font-size: 20px;
        }

        .error-details {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }

        .retry-btn {
            margin-top: 20px;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .retry-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .daily-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .day-cell {
            text-align: center;
            padding: 20px 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .day-cell:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .day-cell .date {
            font-size: 11px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .day-cell .score {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .day-cell .time {
            font-size: 12px;
            color: #888;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 28px;
            background: white;
            border: none;
            border-radius: 50px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            font-size: 16px;
            color: #667eea;
            font-weight: bold;
            transition: all 0.3s;
            z-index: 1000;
        }

        .refresh-btn:hover:not(:disabled) {
            transform: scale(1.08) rotate(90deg);
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.4);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .insights-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }

        .insights-box h3 {
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insights-box p {
            line-height: 1.6;
            opacity: 0.95;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2em;
            }

            .dashboard {
                padding: 20px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .daily-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .tab {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üìä Productivity Tracker</h1>
            <p>Understand your time, master your productivity</p>
        </header>

        <div class="tabs" id="tabs">
            <button class="tab active" data-view="daily">üìÖ Today</button>
            <button class="tab" data-view="weekly">üìä This Week</button>
            <button class="tab" data-view="monthly">üìà This Month</button>
            <button class="tab" data-view="overall">üèÜ All Time</button>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="loading">
                <div class="spinner"></div>
                <div>Loading data...</div>
            </div>
        </div>
    </div>

    <button class="refresh-btn" id="refreshBtn">üîÑ</button>

    <script>
        // Color scheme for charts
        const CHART_COLORS = {
            primary: 'rgb(102, 126, 234)',
            primaryAlpha: 'rgba(102, 126, 234, 0.8)',
            productive: 'rgb(16, 185, 129)',
            productiveAlpha: 'rgba(16, 185, 129, 0.8)',
            communication: 'rgb(59, 130, 246)',
            communicationAlpha: 'rgba(59, 130, 246, 0.8)',
            browsing: 'rgb(245, 158, 11)',
            browsingAlpha: 'rgba(245, 158, 11, 0.8)',
            entertainment: 'rgb(239, 68, 68)',
            entertainmentAlpha: 'rgba(239, 68, 68, 0.8)',
            other: 'rgb(139, 92, 246)',
            otherAlpha: 'rgba(139, 92, 246, 0.8)'
        };

        // State management
        const state = {
            currentView: 'daily',
            charts: {},
            isLoading: false,
            lastError: null
        };

        // Utility functions
        const utils = {
            formatTime(seconds) {
                if (!seconds || isNaN(seconds)) return '0m';
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
            },

            safeGet(obj, path, defaultValue = null) {
                return path.split('.').reduce((acc, part) => acc?.[part], obj) ?? defaultValue;
            },

            validateData(data, requiredFields) {
                if (!data || typeof data !== 'object') return false;
                return requiredFields.every(field => {
                    const value = utils.safeGet(data, field);
                    return value !== null && value !== undefined;
                });
            },

            getCategoryColor(category, alpha = false) {
                const catLower = (category || '').toLowerCase();
                if (catLower === 'productive') return alpha ? CHART_COLORS.productiveAlpha : CHART_COLORS.productive;
                if (catLower === 'communication') return alpha ? CHART_COLORS.communicationAlpha : CHART_COLORS.communication;
                if (catLower === 'browsing') return alpha ? CHART_COLORS.browsingAlpha : CHART_COLORS.browsing;
                if (catLower === 'entertainment') return alpha ? CHART_COLORS.entertainmentAlpha : CHART_COLORS.entertainment;
                return alpha ? CHART_COLORS.otherAlpha : CHART_COLORS.other;
            }
        };

        // Chart management
        const chartManager = {
            destroy(chartId) {
                if (state.charts[chartId]) {
                    try {
                        state.charts[chartId].destroy();
                    } catch (e) {
                        console.warn(`Failed to destroy chart ${chartId}:`, e);
                    }
                    delete state.charts[chartId];
                }
            },

            destroyAll() {
                Object.keys(state.charts).forEach(id => this.destroy(id));
            },

            create(id, config) {
                this.destroy(id);
                const canvas = document.getElementById(id);
                if (!canvas) {
                    console.error(`Canvas element ${id} not found`);
                    return null;
                }
                try {
                    state.charts[id] = new Chart(canvas, config);
                    return state.charts[id];
                } catch (e) {
                    console.error(`Failed to create chart ${id}:`, e);
                    return null;
                }
            }
        };

        // Insight generator
        function getInsight(data) {
            const score = utils.safeGet(data, 'productivity_score') ||
                utils.safeGet(data, 'average_productivity_score') ||
                utils.safeGet(data, 'overall_productivity_score') || 0;

            if (score >= 80) {
                return {
                    emoji: 'üî•',
                    title: 'Outstanding!',
                    message: 'You\'re crushing it! Your focus is incredible. Keep this momentum going!'
                };
            } else if (score >= 60) {
                return {
                    emoji: 'üí™',
                    title: 'Great Work!',
                    message: 'Solid productivity! You\'re on the right track. A few tweaks could make you unstoppable!'
                };
            } else if (score >= 40) {
                return {
                    emoji: '‚ö°',
                    title: 'Room for Improvement',
                    message: 'You have potential! Identify your time-wasters and turn them into productive hours.'
                };
            } else {
                return {
                    emoji: 'üéØ',
                    title: 'Time to Focus',
                    message: 'Don\'t worry! Awareness is the first step. Use this data to make small changes daily.'
                };
            }
        }

        function getCategoryClass(category) {
            const categoryMap = {
                'productive': 'productive',
                'communication': 'communication',
                'browsing': 'browsing',
                'entertainment': 'entertainment'
            };
            return categoryMap[category?.toLowerCase()] || '';
        }

        // API handler
        async function fetchData(view) {
            const response = await fetch(`/api/${view}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const data = await response.json();
            return data;
        }

        // View renderers
        function renderDailyView(data) {
            if (!utils.validateData(data, ['total_time_formatted', 'productivity_score'])) {
                return renderEmptyState('No data available for today');
            }

            const insight = getInsight(data);
            const topApps = utils.safeGet(data, 'top_apps', []);

            const html = `
                <div class="insights-box">
                    <h3>${insight.emoji} ${insight.title}</h3>
                    <p>${insight.message}</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Time Tracked</h3>
                        <div class="value">${data.total_time_formatted || '0m'}</div>
                        <div class="subtext">Active screen time</div>
                    </div>
                    <div class="stat-card">
                        <h3>Productive Time</h3>
                        <div class="value">${data.productive_time_formatted || '0m'}</div>
                        <div class="subtext">Focus work completed</div>
                    </div>
                    <div class="stat-card">
                        <h3>Productivity Score</h3>
                        <div class="value">${data.productivity_score || 0}%</div>
                        <div class="subtext">${data.productivity_score >= 70 ? 'Above average! üéâ' : 'Keep pushing! üí™'}</div>
                    </div>
                </div>
                
                ${topApps.length > 0 ? `
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>üìä Time Distribution</h3>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>üéØ Productivity Breakdown</h3>
                        <div class="chart-container">
                            <canvas id="productivityPieChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üîù Top Applications</h2>
                    <ul class="app-list">
                        ${topApps.map((app, index) => `
                            <li class="app-item">
                                <div class="app-info">
                                    <span class="app-rank">#${index + 1}</span>
                                    <span class="app-name">${app.app || 'Unknown'}</span>
                                    <span class="app-category ${getCategoryClass(app.category)}">${app.category || 'other'}</span>
                                </div>
                                <div>
                                    <span class="app-time">${app.time_formatted || '0m'}</span>
                                    <span class="app-percentage">${(app.percentage || 0).toFixed(1)}%</span>
                                </div>
                            </li>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${app.percentage || 0}%"></div>
                            </div>
                        `).join('')}
                    </ul>
                </div>
                ` : renderEmptyState('Start using apps to see statistics')}
            `;

            document.getElementById('dashboard').innerHTML = html;

            if (topApps.length > 0) {
                createDailyCharts(data);
            }
        }

        function createDailyCharts(data) {
            const topApps = utils.safeGet(data, 'top_apps', []);

            // Category chart
            const categoryData = {};
            topApps.forEach(app => {
                const cat = app.category || 'other';
                categoryData[cat] = (categoryData[cat] || 0) + (app.time_seconds || 0);
            });

            const categoryColors = Object.keys(categoryData).map(cat => utils.getCategoryColor(cat, true));
            const categoryBorders = Object.keys(categoryData).map(cat => utils.getCategoryColor(cat, false));

            chartManager.create('categoryChart', {
                type: 'bar',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        label: 'Time (seconds)',
                        data: Object.values(categoryData),
                        backgroundColor: categoryColors,
                        borderColor: categoryBorders,
                        borderWidth: 2,
                        borderRadius: 10,
                        hoverBackgroundColor: categoryColors,
                        hoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 800,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: (context) => utils.formatTime(context.raw)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                callback: (value) => utils.formatTime(value),
                                padding: 10,
                                font: { size: 12 }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                padding: 10,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });

            // Productivity pie chart
            const productiveTime = utils.safeGet(data, 'productive_time_seconds', 0);
            const totalTime = utils.safeGet(data, 'total_time_seconds', 1);
            const otherTime = Math.max(0, totalTime - productiveTime);

            chartManager.create('productivityPieChart', {
                type: 'doughnut',
                data: {
                    labels: ['Productive', 'Other'],
                    datasets: [{
                        data: [productiveTime, otherTime],
                        backgroundColor: [
                            CHART_COLORS.productiveAlpha,
                            CHART_COLORS.entertainmentAlpha
                        ],
                        borderColor: '#fff',
                        borderWidth: 3,
                        hoverOffset: 15,
                        hoverBorderWidth: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: { size: 14, weight: '600' },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const time = utils.formatTime(context.raw);
                                    const percent = ((context.raw / totalTime) * 100).toFixed(1);
                                    return `${label}: ${time} (${percent}%)`;
                                }
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
        }

        function renderWeeklyView(data) {
            if (!utils.validateData(data, ['total_time_formatted', 'average_productivity_score'])) {
                return renderEmptyState('No data available for this week');
            }

            const insight = getInsight(data);
            const dailyBreakdown = utils.safeGet(data, 'daily_breakdown', []);
            const topApps = utils.safeGet(data, 'top_apps', []);

            const html = `
                <div class="insights-box">
                    <h3>${insight.emoji} ${insight.title}</h3>
                    <p>${insight.message}</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Time</h3>
                        <div class="value">${data.total_time_formatted || '0m'}</div>
                        <div class="subtext">Last 7 days</div>
                    </div>
                    <div class="stat-card">
                        <h3>Productive Time</h3>
                        <div class="value">${data.productive_time_formatted || '0m'}</div>
                        <div class="subtext">Focus work done</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Productivity</h3>
                        <div class="value">${data.average_productivity_score || 0}%</div>
                        <div class="subtext">Daily average</div>
                    </div>
                </div>
                
                ${dailyBreakdown.length > 0 ? `
                <div class="charts-grid">
                    <div class="chart-card" style="grid-column: 1 / -1;">
                        <h3>üìà Weekly Productivity Trend</h3>
                        <div class="chart-container">
                            <canvas id="weeklyChart"></canvas>
                        </div>
                    </div>
                    ${topApps.length > 0 ? `
                    <div class="chart-card">
                        <h3>üìä Top Apps</h3>
                        <div class="chart-container">
                            <canvas id="appsChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>‚è∞ Time Investment</h3>
                        <div class="chart-container">
                            <canvas id="timeChart"></canvas>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="section">
                    <h2>üìÖ Daily Breakdown</h2>
                    <div class="daily-grid">
                        ${dailyBreakdown.map(day => {
                const date = new Date(day.date);
                return `
                            <div class="day-cell">
                                <div class="date">${date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                                <div class="score">${day.productivity_score || 0}%</div>
                                <div class="time">${day.total_time_formatted || '0m'}</div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${day.productivity_score || 0}%; background: ${CHART_COLORS.primaryAlpha};"></div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
                ` : renderEmptyState('No data for this week yet')}
            `;

            document.getElementById('dashboard').innerHTML = html;

            if (dailyBreakdown.length > 0) {
                createWeeklyCharts(data);
            }
        }

        function createWeeklyCharts(data) {
            const dailyBreakdown = utils.safeGet(data, 'daily_breakdown', []);

            // Weekly trend
            chartManager.create('weeklyChart', {
                type: 'line',
                data: {
                    labels: dailyBreakdown.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Productivity Score',
                        data: dailyBreakdown.map(d => d.productivity_score || 0),
                        borderColor: CHART_COLORS.primary,
                        backgroundColor: 'rgba(102, 126, 234, 0.15)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: CHART_COLORS.primary,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 3,
                        pointHoverRadius: 9,
                        pointHoverBorderWidth: 4,
                        shadowOffsetX: 0,
                        shadowOffsetY: 4,
                        shadowBlur: 10,
                        shadowColor: 'rgba(102, 126, 234, 0.3)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                callback: (value) => value + '%',
                                padding: 10,
                                font: { size: 12 }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.03)',
                                drawBorder: false
                            },
                            ticks: {
                                padding: 10,
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });

            // Top apps
            const topApps = utils.safeGet(data, 'top_apps', []).slice(0, 5);
            if (topApps.length > 0) {
                const appColors = topApps.map(app => utils.getCategoryColor(app.category, true));
                const appBorders = topApps.map(app => utils.getCategoryColor(app.category, false));

                chartManager.create('appsChart', {
                    type: 'bar',
                    data: {
                        labels: topApps.map(a => a.app || 'Unknown'),
                        datasets: [{
                            label: 'Time',
                            data: topApps.map(a => a.time_seconds || 0),
                            backgroundColor: appColors,
                            borderColor: appBorders,
                            borderWidth: 2,
                            borderRadius: 10,
                            hoverBackgroundColor: appColors,
                            hoverBorderWidth: 3
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 800,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                cornerRadius: 8,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: (context) => utils.formatTime(context.raw)
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)',
                                    drawBorder: false
                                },
                                ticks: {
                                    callback: (value) => utils.formatTime(value),
                                    padding: 10,
                                    font: { size: 12 }
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    padding: 10,
                                    font: { size: 12 }
                                }
                            }
                        }
                    }
                });

                // Time investment
                const productiveTime = utils.safeGet(data, 'productive_time_seconds', 0);
                const totalTime = utils.safeGet(data, 'total_time_seconds', 1);
                const otherTime = Math.max(0, totalTime - productiveTime);

                chartManager.create('timeChart', {
                    type: 'doughnut',
                    data: {
                        labels: ['Productive', 'Other'],
                        datasets: [{
                            data: [productiveTime, otherTime],
                            backgroundColor: [
                                CHART_COLORS.productiveAlpha,
                                CHART_COLORS.entertainmentAlpha
                            ],
                            borderColor: '#fff',
                            borderWidth: 3,
                            hoverOffset: 15,
                            hoverBorderWidth: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            animateRotate: true,
                            animateScale: true,
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    font: { size: 14, weight: '600' },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                cornerRadius: 8,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 }
                            }
                        },
                        cutout: '65%'
                    }
                });
            }
        }

        function renderMonthlyView(data) {
            if (!utils.validateData(data, ['total_time_formatted', 'productivity_score'])) {
                return renderEmptyState('No data available for this month');
            }

            const insight = getInsight(data);
            const categories = utils.safeGet(data, 'categories', []);
            const dailyData = utils.safeGet(data, 'daily_data', []);

            const html = `
                <div class="insights-box">
                    <h3>${insight.emoji} ${insight.title}</h3>
                    <p>${insight.message}</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Days Tracked</h3>
                        <div class="value">${data.total_days || 0}</div>
                        <div class="subtext">This month</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Time</h3>
                        <div class="value">${data.total_time_formatted || '0m'}</div>
                        <div class="subtext">Cumulative</div>
                    </div>
                    <div class="stat-card">
                        <h3>Productive Time</h3>
                        <div class="value">${data.productive_time_formatted || '0m'}</div>
                        <div class="subtext">Focus work</div>
                    </div>
                    <div class="stat-card">
                        <h3>Productivity Score</h3>
                        <div class="value">${data.productivity_score || 0}%</div>
                        <div class="subtext">Monthly average</div>
                    </div>
                </div>
                
                ${dailyData.length > 0 ? `
                <div class="charts-grid">
                    <div class="chart-card" style="grid-column: 1 / -1;">
                        <h3>üìà Monthly Progress</h3>
                        <div class="chart-container">
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                    </div>
                    ${categories.length > 0 ? `
                    <div class="chart-card">
                        <h3>üìä Category Distribution</h3>
                        <div class="chart-container">
                            <canvas id="categoryPieChart"></canvas>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                ${categories.length > 0 ? `
                <div class="section">
                    <h2>üìä Category Breakdown</h2>
                    <ul class="app-list">
                        ${categories.map(cat => `
                            <li class="app-item">
                                <div class="app-info">
                                    <span class="app-name">${cat.category || 'Unknown'}</span>
                                </div>
                                <div>
                                    <span class="app-time">${cat.time_formatted || '0m'}</span>
                                    <span class="app-percentage">${(cat.percentage || 0).toFixed(1)}%</span>
                                </div>
                            </li>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${cat.percentage || 0}%; background: ${utils.getCategoryColor(cat.category, false)};"></div>
                            </div>
                        `).join('')}
                    </ul>
                </div>
                ` : ''}
                ` : renderEmptyState('No data for this month yet')}
            `;

            document.getElementById('dashboard').innerHTML = html;

            if (dailyData.length > 0) {
                createMonthlyCharts(data);
            }
        }

        function createMonthlyCharts(data) {
            const dailyData = utils.safeGet(data, 'daily_data', []);

            chartManager.create('monthlyTrendChart', {
                type: 'line',
                data: {
                    labels: dailyData.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Productivity Score',
                        data: dailyData.map(d => d.productivity_score || 0),
                        borderColor: CHART_COLORS.primary,
                        backgroundColor: 'rgba(102, 126, 234, 0.15)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointBackgroundColor: CHART_COLORS.primary,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 8,
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                title: (tooltipItems) => {
                                    const item = tooltipItems[0];
                                    const date = new Date(dailyData[item.dataIndex].date);
                                    return date.toLocaleDateString('en-US', {
                                        weekday: 'long',
                                        month: 'long',
                                        day: 'numeric'
                                    });
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                callback: (value) => value + '%',
                                padding: 10,
                                font: { size: 12 }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.03)',
                                drawBorder: false
                            },
                            ticks: {
                                padding: 10,
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    }
                }
            });

            const categories = utils.safeGet(data, 'categories', []);
            if (categories.length > 0) {
                const catColors = categories.map(cat => utils.getCategoryColor(cat.category, true));

                chartManager.create('categoryPieChart', {
                    type: 'pie',
                    data: {
                        labels: categories.map(c => c.category || 'Unknown'),
                        datasets: [{
                            data: categories.map(c => c.time_seconds || 0),
                            backgroundColor: catColors,
                            borderColor: '#fff',
                            borderWidth: 3,
                            hoverOffset: 15,
                            hoverBorderWidth: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            animateRotate: true,
                            animateScale: true,
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 13, weight: '600' },
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                cornerRadius: 8,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const time = utils.formatTime(context.raw);
                                        return `${label}: ${time}`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderOverallView(data) {
            if (!utils.validateData(data, ['total_time_formatted', 'overall_productivity_score'])) {
                return renderEmptyState('No historical data available yet');
            }

            const insight = getInsight(data);
            const topApps = utils.safeGet(data, 'top_apps_alltime', []);
            const bestDay = utils.safeGet(data, 'best_day', {});

            const html = `
                <div class="insights-box">
                    <h3>${insight.emoji} ${insight.title}</h3>
                    <p>You've been tracking for ${data.total_days_tracked || 0} days. ${insight.message}</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Days Tracked</h3>
                        <div class="value">${data.total_days_tracked || 0}</div>
                        <div class="subtext">Since ${data.first_tracked_day || 'N/A'}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Time</h3>
                        <div class="value">${data.total_time_formatted || '0m'}</div>
                        <div class="subtext">All-time cumulative</div>
                    </div>
                    <div class="stat-card">
                        <h3>Productive Time</h3>
                        <div class="value">${data.productive_time_formatted || '0m'}</div>
                        <div class="subtext">Focus work completed</div>
                    </div>
                    <div class="stat-card">
                        <h3>Overall Score</h3>
                        <div class="value">${data.overall_productivity_score || 0}%</div>
                        <div class="subtext">Lifetime average</div>
                    </div>
                </div>
                
                ${bestDay.date ? `
                <div class="section">
                    <h2>üèÜ Best Day</h2>
                    <div class="app-item" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border: none; color: white;">
                        <div class="app-info">
                            <span style="font-size: 32px;">üèÖ</span>
                            <span class="app-name" style="font-size: 20px; color: white;">${bestDay.date}</span>
                        </div>
                        <span class="app-time" style="font-size: 24px; color: white;">${bestDay.productive_time_formatted || '0m'}</span>
                    </div>
                </div>
                ` : ''}
                
                ${topApps.length > 0 ? `
                <div class="charts-grid">
                    <div class="chart-card" style="grid-column: 1 / -1;">
                        <h3>üîù All-Time Top Applications</h3>
                        <div class="chart-container">
                            <canvas id="alltimeChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>üì± Application Hall of Fame</h2>
                    <ul class="app-list">
                        ${topApps.map((app, index) => `
                            <li class="app-item">
                                <div class="app-info">
                                    <span class="app-rank">#${index + 1}</span>
                                    <span class="app-name">${app.app || 'Unknown'}</span>
                                    <span class="app-category ${getCategoryClass(app.category)}">${app.category || 'other'}</span>
                                </div>
                                <span class="app-time">${app.time_formatted || '0m'}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
                ` : renderEmptyState('Start tracking to see your top apps')}
            `;

            document.getElementById('dashboard').innerHTML = html;

            if (topApps.length > 0) {
                createOverallCharts(data);
            }
        }

        function createOverallCharts(data) {
            const topApps = utils.safeGet(data, 'top_apps_alltime', []).slice(0, 10);
            const appColors = topApps.map(app => utils.getCategoryColor(app.category, true));
            const appBorders = topApps.map(app => utils.getCategoryColor(app.category, false));

            chartManager.create('alltimeChart', {
                type: 'bar',
                data: {
                    labels: topApps.map(a => a.app || 'Unknown'),
                    datasets: [{
                        label: 'Total Time',
                        data: topApps.map(a => a.time_seconds || 0),
                        backgroundColor: appColors,
                        borderColor: appBorders,
                        borderWidth: 2,
                        borderRadius: 10,
                        hoverBackgroundColor: appColors,
                        hoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 800,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: (context) => utils.formatTime(context.raw)
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            },
                            ticks: {
                                callback: (value) => utils.formatTime(value),
                                padding: 10,
                                font: { size: 12 }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                padding: 10,
                                font: { size: 11 },
                                maxRotation: 45,
                                minRotation: 0
                            }
                        }
                    }
                }
            });
        }

        function renderEmptyState(message) {
            return `
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <h3>${message}</h3>
                    <p>Data will appear here once available</p>
                </div>
            `;
        }

        function renderError(error) {
            const html = `
                <div class="error">
                    <h3>‚ö†Ô∏è Error Loading Data</h3>
                    <p>Unable to fetch productivity data. Please check the following:</p>
                    <ul style="margin: 15px 0; padding-left: 25px;">
                        <li>Make sure the server is running: <code>python server.py</code></li>
                        <li>Check that the API endpoint is accessible</li>
                        <li>Verify your network connection</li>
                    </ul>
                    <div class="error-details">
                        <strong>Error details:</strong><br>
                        ${error.message || 'Unknown error'}
                    </div>
                    <button class="retry-btn" onclick="refreshData()">üîÑ Retry</button>
                </div>
            `;
            document.getElementById('dashboard').innerHTML = html;
        }

        // Main data loading function
        async function loadView(view) {
            if (state.isLoading) return;

            state.currentView = view;
            state.isLoading = true;

            // Update UI
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
                tab.disabled = true;
            });

            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;

            try {
                await refreshData();
            } finally {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.disabled = false;
                });
                refreshBtn.disabled = false;
                state.isLoading = false;
            }
        }

        async function refreshData() {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading ${state.currentView} data...</div>
                </div>
            `;

            // Destroy existing charts
            chartManager.destroyAll();

            try {
                const data = await fetchData(state.currentView);

                // Route to appropriate renderer
                switch (state.currentView) {
                    case 'daily':
                        renderDailyView(data);
                        break;
                    case 'weekly':
                        renderWeeklyView(data);
                        break;
                    case 'monthly':
                        renderMonthlyView(data);
                        break;
                    case 'overall':
                        renderOverallView(data);
                        break;
                    default:
                        throw new Error(`Unknown view: ${state.currentView}`);
                }

                state.lastError = null;
            } catch (error) {
                console.error('Error loading data:', error);
                state.lastError = error;
                renderError(error);
            }
        }

        // Event listeners
        document.getElementById('tabs').addEventListener('click', (e) => {
            const tab = e.target.closest('.tab');
            if (tab && !tab.disabled) {
                loadView(tab.dataset.view);
            }
        });

        document.getElementById('refreshBtn').addEventListener('click', () => {
            if (!state.isLoading) {
                refreshData();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                refreshData();
            }
        });

        // Initialize
        window.addEventListener('load', () => {
            loadView('daily');
        });

        // Auto-refresh every 5 minutes
        setInterval(() => {
            if (!state.isLoading && document.visibilityState === 'visible') {
                console.log('Auto-refreshing data...');
                refreshData();
            }
        }, 5 * 60 * 1000);
    </script>
</body>

</html>